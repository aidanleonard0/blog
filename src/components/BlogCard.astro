---
import { Badge } from '@/components/ui/badge'
import { Separator } from '@/components/ui/separator'
import {
  getCombinedReadingTime,
  getSubpostCount,
  isSubpost,
  parseAuthors,
} from '@/lib/data-utils'
import { formatDate } from '@/lib/utils'
import { Icon } from 'astro-icon/components'
import type { CollectionEntry } from 'astro:content'
import Link from './Link.astro'

interface Props {
  entry: CollectionEntry<'blog'>
}

const { entry } = Astro.props
const formattedDate = formatDate(entry.data.date)
const readTime = await getCombinedReadingTime(entry.id)
const authors = await parseAuthors(entry.data.authors ?? [])
const subpostCount = !isSubpost(entry.id) ? await getSubpostCount(entry.id) : 0
---

<div class="transition-colors duration-200 ease-out">
  <Link
    href={`/${entry.collection}/${entry.id}`}
    class="hover:bg-muted/50 border-muted-foreground block border-2 p-3 md:p-5"
  >
    <div class="flex flex-col gap-4 sm:flex-row">
      <div class="flex grow flex-col">
        <!-- Top row -->
        <div class="flex items-center gap-3">
          <h3 class="min-w-0 grow text-2xl font-medium">
            {entry.data.title}
          </h3>

          <span class="hidden text-sm whitespace-nowrap lg:inline">
            {readTime}
          </span>
        </div>

        <!-- Meta row for small layouts -->
        <div
          class="text-muted-foreground flex items-center gap-2 text-sm whitespace-nowrap lg:hidden"
        >
          <span>{formattedDate}</span>
          <Separator orientation="vertical" className="h-4!" />
          <span>{readTime}</span>
        </div>

        <!-- Date row for large layouts -->
        <div class="hidden text-sm whitespace-nowrap lg:block">
          <span>{formattedDate}</span>
        </div>

        <!-- Description -->
        <p class="text-muted-foreground mt-2 mb-2">
          {entry.data.description}
        </p>

        <!-- Bottom row -->
        <div class="flex items-end justify-between gap-3">
          {
            entry.data.tags && (
              <div class="flex flex-wrap gap-2">
                {entry.data.tags.map((tag) => (
                  <Badge variant="muted" className="flex items-center gap-x-1">
                    <Icon name="lucide:hash" class="size-3" />
                    {tag}
                  </Badge>
                ))}
              </div>
            )
          }

          {
            subpostCount > 0 && (
              <div class="text-muted-foreground text-xs whitespace-nowrap">
                <span class="flex items-center gap-1">
                  <Icon name="lucide:file-text" class="size-3" />
                  {subpostCount} subpost{subpostCount === 1 ? '' : 's'}
                </span>
              </div>
            )
          }
        </div>
      </div>
    </div>
  </Link>
</div>
